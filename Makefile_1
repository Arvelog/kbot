APP := $(shell basename $$(pwd))
REGISTRY := quay.io/projectquay
VERSION := $(shell git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")-$(shell git rev-parse --short HEAD)

# Define platforms
PLATFORMS := linux windows darwin
ARCHITECTURES := amd64 arm64

# Define clean task
clean:
	docker rmi ${REGISTRY}/${APP}:${VERSION} || true

# Define build tasks for each platform
define BUILD_template
build-$(1)-$(2):
	CGO_ENABLED=0 GOOS=$(1) GOARCH=$(2) go build -o $(APP)-$(1)-$(2)
endef

# Generate build tasks
$(foreach platform,$(PLATFORMS),$(foreach arch,$(ARCHITECTURES),$(eval $(call BUILD_template,$(platform),$(arch)))))

# Define image build and push tasks
image: build-linux-amd64
	docker build . -t ${REGISTRY}/${APP}:${VERSION}
	docker push ${REGISTRY}/${APP}:${VERSION}
